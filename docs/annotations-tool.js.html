<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: annotations-tool.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: annotations-tool.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>/**
 *  Copyright 2012, Entwine GmbH, Switzerland
 *  Licensed under the Educational Community License, Version 2.0
 *  (the "License"); you may not use this file except in compliance
 *  with the License. You may obtain a copy of the License at
 *
 *  http://www.osedu.org/licenses/ECL-2.0
 *
 *  Unless required by applicable law or agreed to in writing,
 *  software distributed under the License is distributed on an "AS IS"
 *  BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 *  or implied. See the License for the specific language governing
 *  permissions and limitations under the License.
 *
 */

/**
 * Module containing the tool main object
 * @module annotations-tool
 * @requires jQuery
 * @requires backbone
 * @requires views-main
 * @requires views-alert
 * @requires templates/delete-modal.tmpl
 * @requires templates/delete-warning-content.tmpl
 * @requires player-adapter
 * @requires handlebars
 */
define(["jquery",
        "backbone",
        "views/main",
        "views/alert",
        "text!templates/delete-modal.tmpl",
        "text!templates/delete-warning-content.tmpl",
        "prototypes/player_adapter",
        "handlebars"],

        function ($, Backbone, MainView, AlertView, DeleteModalTmpl, DeleteContentTmpl, PlayerAdapter, Handlebars) {

            "use strict";

            /**
             * The main object of the annotations tool
             * @namespace annotationsTool
             */
            window.annotationsTool = {

                EVENTS: {
                    ANNOTATION_SELECTION: "annotation-selection"
                },

                views: {},

                deleteModalTmpl: Handlebars.compile(DeleteModalTmpl),

                deleteContentTmpl: Handlebars.compile(DeleteContentTmpl),

                deleteOperation: {
                    /**
                     * Function to delete element with warning
                     *
                     * @param {Object} target Element to be delete
                     * @param {TargetsType} type Type of the target to be deleted
                     */
                    start: function (target, type, callback) {
                        var confirm = function () {
                                type.destroy(target, callback);
                                this.deleteModal.modal("toggle");
                            },
                            confirmWithEnter = function (event) {
                                if (event.keyCode === 13) {
                                    confirm();
                                }
                            };

                        confirmWithEnter = _.bind(confirmWithEnter, this);
                        confirm = _.bind(confirm, this);

                        // Change modal title
                        this.deleteModalHeader.text("Delete " + type.name);

                        // Change warning content
                        this.deleteModalContent.html(this.deleteContentTmpl({
                            type: type.name,
                            content: type.getContent(target)
                        }));

                        // Listener for delete confirmation
                        this.deleteModal.find("#confirm-delete").one("click", confirm);

                        // Add possiblity to confirm with return key
                        $(window).bind("keypress", confirmWithEnter);

                        // Unbind the listeners when the modal is hidden
                        this.deleteModal.one("hide", function () {
                            $("#confirm-delete").unbind("click");
                            $(window).unbind("keypress", confirmWithEnter);
                        });

                        // Show the modal
                        this.deleteModal.modal("show");
                    }
                },

                alertModal: new AlertView(),

                /**
                 * Initialize the tool
                 * @alias   annotationsTool.start
                 * @param  {module:annotations-tool-configuration.Configuration} config The tool configuration
                 */
                start: function (config) {
                    _.bindAll(this, "updateSelectionOnTimeUpdate",
                                    "setSelection",
                                    "getSelection",
                                    "hasSelection");

                    _.extend(this, config, _.clone(Backbone.Events));

                    if (this.loadVideo) {
                        this.loadVideo();
                    }

                    this.deleteOperation.start = _.bind(this.deleteOperation.start, this);
                    this.initDeleteModal();
                    $(this.playerAdapter).bind(PlayerAdapter.EVENTS.TIMEUPDATE, this.updateSelectionOnTimeUpdate);
                    this.views.main = new MainView(this.playerAdapter);
                },

                /**
                 * Display an alert modal
                 * @alias   annotationsTool.alertError
                 * @param  {String} message The message to display
                 */
                alertError: function (message) {
                    this.alertModal.show(message, this.alertModal.TYPES.ERROR);
                },

                /**
                 * Display an warning modal
                 * @alias   annotationsTool.alertWarning
                 * @param  {String} message The message to display
                 */
                alertWarning: function (message) {
                    this.alertModal.show(message, this.alertModal.TYPES.WARNING);
                },

                /**
                 * Display an information modal
                 * @alias   annotationsTool.alertInfo
                 * @param  {String} message The message to display
                 */
                alertInfo: function (message) {
                    this.alertModal.show(message, this.alertModal.TYPES.INFO);
                },

                /**
                 * Function to init the delete warning modal
                 * @alias   annotationsTool.initDeleteModal
                 */
                initDeleteModal: function () {
                    $("#dialogs").append(this.deleteModalTmpl({type: "annotation"}));
                    this.deleteModal = $("#modal-delete").modal({show: true, backdrop: false, keyboard: true });
                    this.deleteModal.modal("toggle");
                    this.deleteModalHeader  = this.deleteModal.find(".modal-header h3");
                    this.deleteModalContent = this.deleteModal.find(".modal-body");
                },

                /**
                 * Transform time in seconds (i.e. 12.344) into a well formated time (01:12:04)
                 * @alias   annotationsTool.getWellFormatedTime
                 * @param {number} the time in seconds
                 */
                getWellFormatedTime: function (time) {
                    var twoDigit = function (number) {
                            return (number &lt; 10 ? "0" : "") + number;
                        },
                        base    = Math.round(time),
                        seconds = base % 60,
                        minutes = ((base - seconds) / 60) % 60,
                        hours   = (base - seconds - minutes * 60) / 3600;

                    return twoDigit(hours) + ":" + twoDigit(minutes) + ":" + twoDigit(seconds);
                },

                /**
                 * Check if the current browser is Safari 6
                 * @alias   annotationsTool.isBrowserSafari6
                 * @return {boolean} true if the browser is safari 6, otherwise false
                 */
                isBrowserSafari6: function () {
                    return (navigator.appVersion.search("Version/6") > 0 && navigator.appVersion.search("Safari") > 0);
                },

                /**
                 * Check if the current browser is Microsoft Internet Explorer 9
                 * @alias   annotationsTool.isBrowserIE9
                 * @return {boolean} true if the browser is IE9, otherwise false
                 */
                isBrowserIE9: function () {
                    return (navigator.appVersion.search("MSIE 9") > 0);
                },

                ///////////////////////////////////////////////
                // Function related to annotation selection  //
                ///////////////////////////////////////////////

                /**
                 * Set the given annotation as current selection
                 * @alias   annotationsTool.setSelection
                 * @param {Array} selection The new selection
                 * @param {Boolean} moveTo define if the video should be move to the start point of the selection
                 */
                setSelection: function (selection, moveTo) {
                    this.currentSelection = selection;

                    // if the selection is not empty, we move the playhead to it
                    if (_.isArray(selection) && selection.length > 0 && moveTo) {
                        this.playerAdapter.setCurrentTime(selection[0].get("start"));
                        this.isManualSelected = true;
                    } else {
                        this.isManualSelected = false;
                    }

                    // Trigger the seleciton event
                    this.trigger(this.EVENTS.ANNOTATION_SELECTION, this.currentSelection);
                },

                /**
                 * Returns the current selection of the tool
                 * @alias   annotationsTool.getSelection
                 * @return {Annotation} The current selection or undefined if no selection.
                 */
                getSelection: function () {
                    return this.currentSelection;
                },

                /**
                 * Informs if there is or not some items selected
                 * @alias   annotationsTool.hasSelection
                 * @return {Boolean} true if an annotation is selected or false.
                 */
                hasSelection: function () {
                    return (typeof this.currentSelection !== "undefined" && (_.isArray(this.currentSelection) && this.currentSelection.length > 0));
                },

                /**
                 * Listener for player "timeupdate" event to highlight the current annotations
                 * @alias   annotationsTool.updateSelectionOnTimeUpdate
                 */
                updateSelectionOnTimeUpdate: function () {
                    var currentTime = this.playerAdapter.getCurrentTime(),
                        selection = [],
                        annotations = [],
                        start,
                        duration,
                        end;

                    if (typeof this.video === "undefined" || this.isManualSelected) {
                        return;
                    }

                    this.video.get("tracks").each(function (track) {
                        annotations = annotations.concat(track.get("annotations").models);
                    }, this);

                    _.each(annotations, function (annotation) {

                        start    = annotation.get("start");
                        duration = annotation.get("duration");
                        end      = start + duration;

                        if (_.isNumber(duration) && start &lt;= currentTime && end >= currentTime) {
                            selection.push(annotation);
                        }

                    }, this);

                    this.setSelection(selection, false);
                },


                /**
                 * Delete the annotation with the given id with the track with the given track id
                 * @alias   annotationsTool.deleteAnnotation
                 * @param {Integer} annotationId The id of the annotation to delete
                 * @param {Integer} trackId Id of the track containing the annotation
                 */
                deleteAnnotation: function (annotationId, trackId) {
                    var annotation;

                    if (typeof trackId === "undefined") {
                        annotationsTool.video.get("tracks").each(function (track) {
                            if (track.get("annotations").get(annotationId)) {
                                trackId = track.get("id");
                            }
                        });
                    }

                    annotation = annotationsTool.video.getAnnotation(annotationId, trackId);

                    if (annotation) {
                        this.deleteOperation.start(annotation, this.deleteOperation.targetTypes.ANNOTATION);
                    } else {
                        console.warn("Not able to find annotation %i on track %i", annotationId, trackId);
                    }
                }

            };


            /**
             * Type of target that can be deleted using the delete warning modal
             *
             * Each type object must contain these elements
             *
             * {
             *   name: "Name of the type", // String
             *   getContent: function(target){ // Function
             *       return "Content of the target element"
             *   },
             *   destroy: function(target){ // Function
             *       // Delete the target
             *   }
             * }
             */
            annotationsTool.deleteOperation.targetTypes  = {

                ANNOTATION: {
                    name: "annotation",
                    getContent: function (target) {
                        return target.get("text");
                    },
                    destroy: function (target, callback) {

                        target.destroy({

                            success: function () {
                                if (annotationsTool.localStorage) {
                                    annotationsTool.video.get("tracks").each(function (value) {
                                        if (value.get("annotations").get(target.id)) {
                                            value.get("annotations").remove(target);
                                            value.save({wait: true});
                                            return false;
                                        }
                                    });
                                    annotationsTool.video.save();
                                }
                                if (callback) {
                                    callback();
                                }
                            },
                            error: function (error) {
                                console.warn("Cannot delete annotation: " + error);
                            }
                        });
                    }
                },

                LABEL: {
                    name: "label",
                    getContent: function (target) {
                        return target.get("value");
                    },
                    destroy: function (target, callback) {
                        target.destroy({

                            success: function () {
                                if (annotationsTool.localStorage) {
                                    if (target.collection) {
                                        target.collection.remove(target);
                                    }
                                    annotationsTool.video.save();
                                }
                                if (callback) {
                                    callback();
                                }
                            },
                            error: function (error) {
                                console.warn("Cannot delete label: " + error);
                            }
                        });
                    }
                },

                TRACK: {
                    name: "track",
                    getContent: function (target) {
                        return target.get("name");
                    },
                    destroy: function (track, callback) {
                        var annotations = track.get("annotations"),
                            /**
                             * Recursive function to delete synchronously all annotations
                             */
                            destroyAnnotation = function () {
                                var annotation;

                                // End state, no more annotation
                                if (annotations.length === 0) {
                                    return;
                                }
                                annotation = annotations.at(0);
                                annotation.destroy({
                                    error: function () {
                                        throw "Cannot delete annotation!";
                                    },
                                    success: function () {
                                        annotations.remove(annotation);
                                        destroyAnnotation();
                                    }
                                });
                            };
                        // Call the recursive function
                        destroyAnnotation();
                        track.destroy({
                            success: function () {
                                if (annotationsTool.localStorage) {
                                    annotationsTool.video.save();
                                }
                                if (callback) {
                                    callback();
                                }
                            },
                            error: function (error) {
                                console.warn("Cannot delete track: " + error);
                            }
                        });
                    }
                },

                CATEGORY: {
                    name: "category",
                    getContent: function (target) {
                        return target.get("name");
                    },
                    destroy: function (category, callback) {
                        var labels = category.get("labels"),
                            /**
                             * Recursive function to delete synchronously all labels
                             */
                            destroyLabels = function () {
                                var label;

                                // End state, no more label
                                if (labels.length === 0) {
                                    return;
                                }

                                label = labels.at(0);
                                label.destroy({
                                    error: function () {
                                        throw "Cannot delete label!";
                                    },
                                    success: function () {
                                        labels.remove(label);
                                        destroyLabels();
                                    }
                                });
                            };
                        // Call the recursive function
                        destroyLabels();
                        category.destroy({
                            success: function () {
                                if (annotationsTool.localStorage) {
                                    annotationsTool.video.save();
                                }
                                if (callback) {
                                    callback();
                                }
                            },
                            error: function (error) {
                                console.warn("Cannot delete category: " + error);
                            }
                        });
                    }
                },

                SCALEVALUE: {
                    name: "scale value",
                    getContent: function (target) {
                        return target.get("name");
                    },
                    destroy: function (target, callback) {

                        target.destroy({

                            success: function () {
                                if (window.annotationsTool.localStorage) {
                                    if (target.collection) {
                                        target.collection.remove(target);
                                    }

                                    annotationsTool.video.save();
                                }
                                if (callback) {
                                    callback();
                                }
                            },

                            error: function (error) {
                                console.warn("Cannot delete scale value: " + error);
                            }
                        });
                    }
                },

                SCALE: {
                    name: "scale",
                    getContent: function (target) {
                        return target.get("name");
                    },
                    destroy: function (scale, callback) {
                        var scaleValues = scale.get("scaleValues"),
                            /**
                             * Recursive function to delete synchronously all scaleValues
                             */
                            destroyScaleValues = function () {
                                var scaleValue;
                                // End state, no more label
                                if (scaleValues.length === 0) {
                                    return;
                                }
                                scaleValue = scaleValues.at(0);
                                scaleValue.destroy({
                                    error: function () {
                                        throw "Cannot delete scaleValue!";
                                    },
                                    success: function () {
                                        scaleValues.remove(scaleValue);
                                        destroyScaleValues();
                                    }
                                });
                            };

                        // Call the recursive function
                        destroyScaleValues();

                        scale.destroy({
                            success: function () {
                                if (window.annotationsTool.localStorage) {
                                    annotationsTool.video.save();
                                }
                                if (callback) {
                                    callback();
                                }
                            },
                            error: function (error) {
                                console.warn("Cannot delete scale: " + error);
                            }
                        });
                    }
                }
            };

            return annotationsTool;
        }
);</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Modules</h3><ul><li><a href="module-ACCESS.html">ACCESS</a></li><li><a href="module-annotations-tool.html">annotations-tool</a></li><li><a href="module-annotations-tool-configuration.html">annotations-tool-configuration</a></li><li><a href="module-backbone-annotations-sync.html">backbone-annotations-sync</a></li><li><a href="module-collections-annotations.html">collections-annotations</a></li><li><a href="module-collections-categories.html">collections-categories</a></li><li><a href="module-collections-comments.html">collections-comments</a></li><li><a href="module-collections-labels.html">collections-labels</a></li><li><a href="module-collections-scales.html">collections-scales</a></li><li><a href="module-collections-scalevalues.html">collections-scalevalues</a></li><li><a href="module-collections-tracks.html">collections-tracks</a></li><li><a href="module-collections-users.html">collections-users</a></li><li><a href="module-collections-videos.html">collections-videos</a></li><li><a href="module-filters-manager.html">filters-manager</a></li><li><a href="module-models-annotation.html">models-annotation</a></li><li><a href="module-models-category.html">models-category</a></li><li><a href="module-models-comment.html">models-comment</a></li><li><a href="module-models-label.html">models-label</a></li><li><a href="module-models-scale.html">models-scale</a></li><li><a href="module-models-scalevalue.html">models-scalevalue</a></li><li><a href="module-models-track.html">models-track</a></li><li><a href="module-models-user.html">models-user</a></li><li><a href="module-models-video.html">models-video</a></li><li><a href="module-player-adapter.html">player-adapter</a></li><li><a href="module-player-adapter-HTML5.html">player-adapter-HTML5</a></li><li><a href="module-ROLES.html">ROLES</a></li><li><a href="module-views-alert.html">views-alert</a></li><li><a href="module-views-annotate.html">views-annotate</a></li><li><a href="module-views-annotate-category.html">views-annotate-category</a></li><li><a href="module-views-annotate-label.html">views-annotate-label</a></li><li><a href="module-views-annotate-tab.html">views-annotate-tab</a></li><li><a href="module-views-comment.html">views-comment</a></li><li><a href="module-views-comments-container.html">views-comments-container</a></li><li><a href="module-views-list.html">views-list</a></li><li><a href="module-views-list-annotation.html">views-list-annotation</a></li><li><a href="module-views-login.html">views-login</a></li><li><a href="module-views-main.html">views-main</a></li><li><a href="module-views-scale-editor.html">views-scale-editor</a></li><li><a href="module-views-scalevalue-editor.html">views-scalevalue-editor</a></li><li><a href="module-views-timeline.html">views-timeline</a></li></ul><h3>Classes</h3><ul><li><a href="module-backbone-annotations-sync.AnnotationsSync.html">AnnotationsSync</a></li><li><a href="module-collections-annotations.Annotations.html">Annotations</a></li><li><a href="module-collections-categories.Categories.html">Categories</a></li><li><a href="module-collections-comments.Comments.html">Comments</a></li><li><a href="module-collections-labels.Labels.html">Labels</a></li><li><a href="module-collections-scales.Scales.html">Scales</a></li><li><a href="module-collections-scalevalues.ScaleValues.html">ScaleValues</a></li><li><a href="module-collections-tracks.Tracks.html">Tracks</a></li><li><a href="module-collections-users.User.html">User</a></li><li><a href="module-collections-videos.Videos.html">Videos</a></li><li><a href="module-filters-manager.FiltersManager.html">FiltersManager</a></li><li><a href="module-models-annotation.Annotation.html">Annotation</a></li><li><a href="module-models-category.Category.html">Category</a></li><li><a href="module-models-comment.Comment.html">Comment</a></li><li><a href="module-models-label.Label.html">Label</a></li><li><a href="module-models-scale.Scale.html">Scale</a></li><li><a href="module-models-scalevalue.Scalevalue.html">Scalevalue</a></li><li><a href="module-models-track.Track.html">Track</a></li><li><a href="module-models-user.User.html">User</a></li><li><a href="module-models-video.Video.html">Video</a></li><li><a href="module-player-adapter.PlayerAdapter.html">PlayerAdapter</a></li><li><a href="module-player-adapter-HTML5.PlayerAdapterHTML5.html">PlayerAdapterHTML5</a></li><li><a href="module-views-alert.Alert.html">Alert</a></li><li><a href="module-views-annotate.Annotate.html">Annotate</a></li><li><a href="module-views-annotate-category.CategoryView.html">CategoryView</a></li><li><a href="module-views-annotate-label.LabelView.html">LabelView</a></li><li><a href="module-views-annotate-tab.AnnotateTab.html">AnnotateTab</a></li><li><a href="module-views-comment.Comment.html">Comment</a></li><li><a href="module-views-comments-container.CommentsContainer.html">CommentsContainer</a></li><li><a href="module-views-list.List.html">List</a></li><li><a href="module-views-list-annotation.ListAnnotation.html">ListAnnotation</a></li><li><a href="module-views-login.Login.html">Login</a></li><li><a href="module-views-main.MainView.html">MainView</a></li><li><a href="module-views-scale-editor.ScaleEditor.html">ScaleEditor</a></li><li><a href="module-views-scalevalue-editor.ScaleValueEditor.html">ScaleValueEditor</a></li><li><a href="module-views-timeline.TimelineView.html">TimelineView</a></li></ul><h3>Namespaces</h3><ul><li><a href="annotationsTool.html">annotationsTool</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.0-dev</a> on Wed Mar 20 2013 11:15:04 GMT+0100 (CET)
</footer>

<script> prettyPrint(); </script>
</body>
</html>
