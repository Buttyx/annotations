<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: views/scale-editor.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: views/scale-editor.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>/**
 *  Copyright 2012, Entwine GmbH, Switzerland
 *  Licensed under the Educational Community License, Version 2.0
 *  (the "License"); you may not use this file except in compliance
 *  with the License. You may obtain a copy of the License at
 *
 *  http://www.osedu.org/licenses/ECL-2.0
 *
 *  Unless required by applicable law or agreed to in writing,
 *  software distributed under the License is distributed on an "AS IS"
 *  BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 *  or implied. See the License for the specific language governing
 *  permissions and limitations under the License.
 *
 */

/**
 * A module representing the scale editor
 * @module views-scale-editor
 * @requires jQuery
 * @requires backbone
 * @requires models-scale
 * @requires collections-scales
 * @requires templates/scale-editor.tmpl
 * @requires templates/scale-editor-select.tmpl
 * @requires templates/scale-editor-content.tmpl
 * @requires ACCESS
 * @requires handlebars
 */
define(["jquery",
        "backbone",
        "models/scale",
        "collections/scales",
        "views/scalevalue-editor",
        "text!templates/scale-editor.tmpl",
        "text!templates/scale-editor-select.tmpl",
        "text!templates/scale-editor-content.tmpl",
        "access",
        "handlebars"],
        function ($, Backbone, Scale, Scales, ScaleValueEditorView, ScaleEditorTmpl, ScaleEditorSelectTmpl, ScaleEditorContentTmpl, ACCESS, Handlebars) {

            "use strict";

            /**
             * @constructor
             * @see {@link http://www.backbonejs.org/#View}
             * @memberOf module:views-scale-editor
             * @augments module:Backbone.View
             * @alias module:views-scale-editor.ScaleEditor
             */
            var ScaleEditor = Backbone.View.extend({

                /**
                 * The titles of the different element from the editor
                 * @alias module:views-scale-editor.ScaleEditor#TITLES
                 * @type {map}
                 */
                TITLES: {
                    CATEGORY_EDIT  : "Edit category scale",
                    STANDALONE_EDIT: "Edit scales",
                    SAVE_BUTTON    : "Save",
                    CREATE_BUTTON  : "Create"
                },

                /**
                 * Object representing an empty scale
                 * @alias module:views-scale-editor.ScaleEditor#EMPTY_SCALES
                 * @type {Object}
                 */
                EMPTY_SCALE: {
                    name: "-- NO SCALE --",
                    id  : "NO"
                },

                /**
                 * Main container of the editor modal
                 * @alias module:views-login.Login#el
                 * @type {DOM Element}
                 */
                el: $("#scale-editor"),

                /**
                 * Main template for the scale editor
                 * @alias module:views-login.Login#scaleEditorTemplate
                 * @type {Handlebars template}
                 */
                scaleEditorTemplate: Handlebars.compile(ScaleEditorTmpl),

                /**
                 * Template for the select element of the editor
                 * @alias module:views-login.Login#scaleEditorSelectTemplate
                 * @type {Handlebars template}
                 */
                scaleEditorSelectTemplate: Handlebars.compile(ScaleEditorSelectTmpl),

                /**
                 * Template for the editor content
                 * @alias module:views-login.Login#scaleEditorContentTemplate
                 * @type {Handlebars template}
                 */
                scaleEditorContentTemplate: Handlebars.compile(ScaleEditorContentTmpl),

                /**
                 * Events to handle
                 * @alias module:views-scale-editor.ScaleEditor#events
                 * @type {object}
                 */
                events: {
                    "click #save-scale"         : "save",
                    "click #cancel-scale"       : "cancel",
                    "click a.edit-scale"        : "startEditScale",
                    "click a.create-scale"      : "createScale",
                    "click a.delete-scale"      : "deleteScale",
                    "click a.create-scale-value": "createScaleValue",
                    "change select#scale-id"    : "changeScale",
                    "keydown #save-scale"       : "saveOnInsert"
                },

                /**
                 * Constructor
                 * @alias module:views-scale-editor.ScaleEditor#initialize
                 */
                initialize: function () {

                    _.bindAll(this,
                            "initialize",
                            "saveOnInsert",
                            "save",
                            "startEditScale",
                            "createScale",
                            "createScaleValue",
                            "deleteScale",
                            "changeScale",
                            "cancel",
                            "renderEditContent",
                            "renderScaleSelect",
                            "generateScalesForTemplate",
                            "show",
                            "hide");

                    _.extend(this, Backbone.Events);

                    // Type use for delete operation
                    this.scaleDeleteType = annotationsTool.deleteOperation.targetTypes.SCALE;

                    this.$el.modal({show: true, backdrop: false, keyboard: false });
                    this.$el.modal("hide");
                },

                /**
                 * Display the editor with the given category
                 * @alias module:views-scale-editor.ScaleEditor#show
                 * @param {Category} category The category currently selected
                 */
                show: function (category) {
                    var templateParams = {
                            title: this.TITLES.STANDALONE_EDIT
                        };

                    this.EMPTY_SCALE.isSelected = false;

                    if (category) {
                        this.currentCategory = category;

                        if (category.get("settings").hasScale) {
                            this.currentScaleId = category.get("scale_id");
                        }
                        templateParams.title = this.TITLES.CATEGORY_EDIT;
                    }

                    this.$el.empty();
                    this.$el.append(this.scaleEditorTemplate(templateParams));
                    this.renderScaleSelect();
                    this.changeScale();
                    this.$el.modal("show");
                    this.$el.css("z-index", 400);
                },

                /**
                 * Generate the list of scales to be drawn
                 * @alias module:views-scale-editor.ScaleEditor#generateScalesForTemplate
                 */
                generateScalesForTemplate: function () {
                    var scales = annotationsTool.video.get("scales").toJSON(),
                        selectedScale;

                    // Filter by access values
                    scales = _.where(scales, {access: this.currentCategory.get("access")});

                    scales.push(this.EMPTY_SCALE);

                    if (this.currentScaleId) {
                        selectedScale = _.find(scales, function (scale) {
                                                return scale.id === this.currentScaleId;
                                            }, this);

                        if (selectedScale) {
                            selectedScale.isSelected = true;
                        }
                    } else {
                        this.EMPTY_SCALE.isSelected = true;
                    }
                    return scales;
                },

                /**
                 * Draw the select element
                 * @alias module:views-scale-editor.ScaleEditor#renderScaleSelect
                 */
                renderScaleSelect: function () {
                    this.$el.find("select#scale-id").empty()
                                                    .append(this.scaleEditorSelectTemplate({scales: this.generateScalesForTemplate()}));

                    this.delegateEvents(this.events);
                },

                /**
                 * Hide the editor
                 * @alias module:views-scale-editor.ScaleEditor#hide
                 */
                hide: function () {
                    this.$el.modal("hide");

                    if (this.category) {
                        delete this.category;
                    }
                },

                /**
                 * Proxy to save the current scale by pressing the return key
                 * @alias module:views-scale-editor.ScaleEditor#saveOnInsert
                 * @param  {event} e Event object
                 */
                saveOnInsert: function (e) {
                    if (e.keyCode === 13) {
                        this.save();
                    }
                },

                /**
                 * Save the current scale or category with the modification done in the editor and quit it
                 * @alias module:views-scale-editor.ScaleEditor#save
                 */
                save: function () {
                    var name,
                        description,
                        settings;

                    if (this.isInEditMode) {
                        name = this.$el.find(".modal-body .scale-name").val();
                        description = this.$el.find(".modal-body .scale-description").val();

                        this.currentScale.set({
                            name: name,
                            description: description
                        });

                        if (!this.currentScale.collection) {
                            annotationsTool.video.get("scales").add(this.currentScale);
                            this.currentScale.save({async: false});
                            this.currentScale.setUrl();
                            this.currentScale.get("scaleValues").each(function (scaleValue) {
                                scaleValue.save();
                            });
                            this.currentScaleId = this.currentScale.get("id");
                            this.$el.find("select#scale-id").removeAttr("disabled");
                        }
                        this.isInEditMode = false;
                        this.renderScaleSelect();
                        this.changeScale();

                        this.$el.find(".modal-body").hide();
                        this.$el.find("a#save-scale").text(this.TITLES.SAVE_BUTTON);
                    } else if (this.currentCategory) {
                        settings = this.currentCategory.get("settings");

                        if (this.currentScaleId === this.EMPTY_SCALE.id) {
                            settings.hasScale = false;
                            this.currentCategory.unset("scale_id");
                            this.currentCategory.unset("scale");
                        } else {
                            settings.hasScale = true;
                            this.currentCategory.set({
                                scale_id: this.currentScaleId,
                                scale: this.currentScale
                            });
                        }
                        this.currentCategory.set("settings", settings);
                        this.currentCategory.save();
                        this.changeScale();
                        this.hide();
                    }
                },

                /**
                 * Cancel the modification done and quit
                 * @alias module:views-scale-editor.ScaleEditor#cancel
                 */
                cancel: function () {
                    if (this.isInEditMode) {
                        this.isInEditMode = false;
                        this.renderScaleSelect();
                        this.changeScale();
                        this.$el.find(".modal-body").hide();
                        this.$el.find("select#scale-id").removeAttr("disabled");
                        this.$el.find("a#save-scale").text(this.TITLES.SAVE_BUTTON);
                    } else {
                        this.hide();
                    }
                },

                /**
                 * Change the current scale with the one selected with select input element
                 * @alias module:views-scale-editor.ScaleEditor#changeScale
                 */
                changeScale: function () {
                    this.currentScaleId = this.$el.find("select#scale-id").val();
                    this.currentScale = annotationsTool.video.get("scales").get(this.currentScaleId);

                    if (this.currentScale && this.currentScale.get("isMine")) {
                        if (this.isInEditMode) {
                            this.$el.find("a.edit-scale").hide();
                        } else {
                            this.$el.find("a.edit-scale").show();
                        }
                        this.renderEditContent(this.currentScale);
                    } else {
                        this.isInEditMode = false;
                        this.$el.find("a.edit-scale").hide();
                        this.$el.find(".modal-body").hide();
                    }
                },

                /**
                 * Create a new scale
                 * @alias module:views-scale-editor.ScaleEditor#createScale
                 */
                createScale: function () {
                    this.isInEditMode = true;
                    this.$el.find("a#save-scale").text(this.TITLES.CREATE_BUTTON);
                    this.currentScale = new Scale({
                        name  : "New scale",
                        access: this.currentCategory.get("access")
                    });
                    this.renderEditContent(this.currentScale);
                    this.$el.find("select#scale-id").attr("disabled", "disabled");
                    this.$el.find(".modal-body").show();
                },

                /**
                 * Create a new scale value
                 * @alias module:views-scale-editor.ScaleEditor#createScaleValue
                 */
                createScaleValue: function () {
                    this.currentScale.get("scaleValues").create({
                            order: this.$el.find(".scale-value").length,
                            name : "New scale value",
                            value: 0,
                            access: this.currentCategory.get("access")
                        });
                },

                /**
                 * Delete the current scale
                 * @param  {event} event Event object
                 * @alias module:views-scale-editor.ScaleEditor#deleteScale
                 */
                deleteScale: function (event) {
                    var self = this;

                    event.stopImmediatePropagation();
                    annotationsTool.deleteOperation.start(this.currentScale, this.scaleDeleteType, self.cancel);
                },

                /**
                 * Switch in edit mode for the current scale
                 * @alias module:views-scale-editor.ScaleEditor#startEditScale
                 */
                startEditScale: function () {
                    this.isInEditMode = true;
                    this.$el.find("a#save-scale").text(this.TITLES.SAVE_BUTTON);
                    this.$el.find("a.edit-scale").hide();
                    this.$el.find(".modal-body").show();
                },

                /**
                 * Render the edit content of the editor for the given scale
                 * @alias module:views-scale-editor.ScaleEditor#renderEditContent
                 * @param  {Scale} scale The scale to edit
                 */
                renderEditContent: function (scale) {
                    var scaleValuesViews = [],
                        scaleValues = this.currentScale.get("scaleValues"),
                        // Sort the model in the right scale volue order
                        sortModelByOrderValue = function (model) {
                            return model.get("order");
                        },
                        // Refresh the list of scale values
                        renderScaleValues = function () {
                            scaleValuesViews = _.where(scaleValuesViews, {isDeleted: false});
                            scaleValuesViews = _.sortBy(scaleValuesViews, function (view) {
                                                    return sortModelByOrderValue(view.model);
                                                });

                            this.$el.find(".list-scale-values").empty();

                            _.each(scaleValuesViews, function (view) {
                                this.$el.find(".list-scale-values").append(view.render().$el);
                            }, this);
                        },
                        // Create view from newly added scale value
                        addScaleValue = function (scaleValue, index) {
                            var self = this,
                                params = {
                                    model: scaleValue,
                                    onChange: function () {
                                        renderScaleValues.call(self);
                                    }
                                };

                            scaleValuesViews.push(new ScaleValueEditorView(params));

                            if (!_.isNumber(index)) {
                                renderScaleValues.call(self);
                            }
                        };

                    scaleValues.bind("add", addScaleValue, this);
                    scaleValues = scaleValues.sortBy(sortModelByOrderValue, this);
                    _.each(scaleValues, addScaleValue, this);

                    this.$el.find(".modal-body").empty().append(this.scaleEditorContentTemplate({scale: scale.toJSON()}));
                    renderScaleValues.call(this);
                    this.delegateEvents(this.events);
                }
            });
            return ScaleEditor;
        }
);</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Modules</h3><ul><li><a href="module-ACCESS.html">ACCESS</a></li><li><a href="module-annotations-tool.html">annotations-tool</a></li><li><a href="module-annotations-tool-configuration.html">annotations-tool-configuration</a></li><li><a href="module-backbone-annotations-sync.html">backbone-annotations-sync</a></li><li><a href="module-collections-annotations.html">collections-annotations</a></li><li><a href="module-collections-categories.html">collections-categories</a></li><li><a href="module-collections-comments.html">collections-comments</a></li><li><a href="module-collections-labels.html">collections-labels</a></li><li><a href="module-collections-loops.html">collections-loops</a></li><li><a href="module-collections-scales.html">collections-scales</a></li><li><a href="module-collections-scalevalues.html">collections-scalevalues</a></li><li><a href="module-collections-tracks.html">collections-tracks</a></li><li><a href="module-collections-users.html">collections-users</a></li><li><a href="module-collections-videos.html">collections-videos</a></li><li><a href="module-filters-manager.html">filters-manager</a></li><li><a href="module-models-annotation.html">models-annotation</a></li><li><a href="module-models-category.html">models-category</a></li><li><a href="module-models-comment.html">models-comment</a></li><li><a href="module-models-label.html">models-label</a></li><li><a href="module-models-loop.html">models-loop</a></li><li><a href="module-models-scale.html">models-scale</a></li><li><a href="module-models-scalevalue.html">models-scalevalue</a></li><li><a href="module-models-track.html">models-track</a></li><li><a href="module-models-user.html">models-user</a></li><li><a href="module-models-video.html">models-video</a></li><li><a href="module-player-adapter.html">player-adapter</a></li><li><a href="module-player-adapter-HTML5.html">player-adapter-HTML5</a></li><li><a href="module-ROLES.html">ROLES</a></li><li><a href="module-views-alert.html">views-alert</a></li><li><a href="module-views-annotate.html">views-annotate</a></li><li><a href="module-views-annotate-category.html">views-annotate-category</a></li><li><a href="module-views-annotate-label.html">views-annotate-label</a></li><li><a href="module-views-annotate-tab.html">views-annotate-tab</a></li><li><a href="module-views-comment.html">views-comment</a></li><li><a href="module-views-comments-container.html">views-comments-container</a></li><li><a href="module-views-list.html">views-list</a></li><li><a href="module-views-list-annotation.html">views-list-annotation</a></li><li><a href="module-views-login.html">views-login</a></li><li><a href="module-views-loop.html">views-loop</a></li><li><a href="module-views-main.html">views-main</a></li><li><a href="module-views-scale-editor.html">views-scale-editor</a></li><li><a href="module-views-scalevalue-editor.html">views-scalevalue-editor</a></li><li><a href="module-views-timeline.html">views-timeline</a></li></ul><h3>Classes</h3><ul><li><a href="module-backbone-annotations-sync.AnnotationsSync.html">AnnotationsSync</a></li><li><a href="module-collections-annotations.Annotations.html">Annotations</a></li><li><a href="module-collections-categories.Categories.html">Categories</a></li><li><a href="module-collections-comments.Comments.html">Comments</a></li><li><a href="module-collections-labels.Labels.html">Labels</a></li><li><a href="module-collections-loops.Loops.html">Loops</a></li><li><a href="module-collections-scales.Scales.html">Scales</a></li><li><a href="module-collections-scalevalues.ScaleValues.html">ScaleValues</a></li><li><a href="module-collections-tracks.Tracks.html">Tracks</a></li><li><a href="module-collections-users.User.html">User</a></li><li><a href="module-collections-videos.Videos.html">Videos</a></li><li><a href="module-filters-manager.FiltersManager.html">FiltersManager</a></li><li><a href="module-models-annotation.Annotation.html">Annotation</a></li><li><a href="module-models-category.Category.html">Category</a></li><li><a href="module-models-comment.Comment.html">Comment</a></li><li><a href="module-models-label.Label.html">Label</a></li><li><a href="module-models-loop.Loop.html">Loop</a></li><li><a href="module-models-scale.Scale.html">Scale</a></li><li><a href="module-models-scalevalue.Scalevalue.html">Scalevalue</a></li><li><a href="module-models-track.Track.html">Track</a></li><li><a href="module-models-user.User.html">User</a></li><li><a href="module-models-video.Video.html">Video</a></li><li><a href="module-player-adapter.PlayerAdapter.html">PlayerAdapter</a></li><li><a href="module-player-adapter-HTML5.PlayerAdapterHTML5.html">PlayerAdapterHTML5</a></li><li><a href="module-views-alert.Alert.html">Alert</a></li><li><a href="module-views-annotate.Annotate.html">Annotate</a></li><li><a href="module-views-annotate-category.CategoryView.html">CategoryView</a></li><li><a href="module-views-annotate-label.LabelView.html">LabelView</a></li><li><a href="module-views-annotate-tab.AnnotateTab.html">AnnotateTab</a></li><li><a href="module-views-comment.Comment.html">Comment</a></li><li><a href="module-views-comments-container.CommentsContainer.html">CommentsContainer</a></li><li><a href="module-views-list.List.html">List</a></li><li><a href="module-views-list-annotation.ListAnnotation.html">ListAnnotation</a></li><li><a href="module-views-login.Login.html">Login</a></li><li><a href="module-views-loop.Loop.html">Loop</a></li><li><a href="module-views-main.MainView.html">MainView</a></li><li><a href="module-views-scale-editor.ScaleEditor.html">ScaleEditor</a></li><li><a href="module-views-scalevalue-editor.ScaleValueEditor.html">ScaleValueEditor</a></li><li><a href="module-views-timeline.TimelineView.html">TimelineView</a></li></ul><h3>Namespaces</h3><ul><li><a href="annotationsTool.html">annotationsTool</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.0-dev</a> on Mon Nov 04 2013 23:11:30 GMT+0100 (CET)
</footer>

<script> prettyPrint(); </script>
</body>
</html>
